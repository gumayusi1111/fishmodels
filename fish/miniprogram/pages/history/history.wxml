<view class="container">
  <view class="header">
    <text class="title">å†å²è®°å½•</text>
  </view>

  <!-- æˆæƒæç¤º -->
  <view wx:if="{{needAuth}}" class="auth-prompt">
    <view class="auth-icon">ğŸ”</view>
    <text class="auth-title">éœ€è¦æˆæƒ</text>
    <text class="auth-desc">æŸ¥çœ‹å†å²è®°å½•éœ€è¦å…ˆæˆæƒè·å–ç”¨æˆ·ä¿¡æ¯</text>
    <button class="auth-btn" bindtap="getUserProfile">ç«‹å³æˆæƒ</button>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view wx:elif="{{loading}}" class="loading">
    <view class="loading-spinner"></view>
    <text>åŠ è½½ä¸­...</text>
  </view>

  <!-- å†å²è®°å½•åˆ—è¡¨ -->
  <view wx:elif="{{historyList.length > 0}}" class="history-list">
    <view class="list-header">
      <text class="record-count">å…± {{historyList.length}} æ¡è®°å½•</text>
    </view>
    
    <view wx:for="{{historyList}}" wx:key="_id" class="history-item-card" bindtap="showDetail" data-item="{{item}}">
      <!-- åª’ä½“é¢„è§ˆ -->
      <view class="media-preview">
        <image wx:if="{{item.mediaType === 'image'}}" 
               src="{{item.mediaUrl}}" 
               mode="aspectFill"
               class="preview-image"
               binderror="onImageError"></image>
        <image wx:elif="{{item.mediaType === 'video' && item.coverUrl}}" 
               src="{{item.coverUrl}}" 
               mode="aspectFill"
               class="preview-image"
               binderror="onImageError"></image>
        <view wx:else class="video-placeholder">
          <text class="video-icon">ğŸ¥</text>
          <text class="video-text">è§†é¢‘</text>
        </view>
        <view class="media-type-badge">{{item.mediaType === 'image' ? 'å›¾ç‰‡' : 'è§†é¢‘'}}</view>
      </view>
      
      <!-- å†…å®¹ä¿¡æ¯ -->
      <view class="content-info">
        <view class="species-info">
          <text class="species-name">{{item.result.species.name || item.result.species || 'æœªçŸ¥å“ç§'}}</text>
          <view class="confidence-badge confidence-{{item.result.species.confidence >= 80 ? 'high' : item.result.species.confidence >= 60 ? 'medium' : 'low'}}">
            {{item.result.species.confidence || item.result.confidence || 0}}%
          </view>
        </view>
        <view class="time-info">
          <text class="time-text">{{item.createTime}}</text>
        </view>
        <view wx:if="{{item.result.healthStatus}}" class="health-status status-{{item.result.healthStatus}}">
          {{item.result.healthStatus === 'healthy' ? 'å¥åº·' : item.result.healthStatus === 'abnormal' ? 'å¼‚å¸¸' : 'ç–‘ä¼¼å¼‚å¸¸'}}
        </view>
      </view>
      
      <!-- ç®­å¤´æŒ‡ç¤ºå™¨ -->
      <view class="arrow-indicator">
        <text class="arrow">â€º</text>
      </view>
    </view>
  </view>

  <!-- ç©ºçŠ¶æ€ -->
  <view wx:else class="empty-state">
    <view class="empty-icon">ğŸ“</view>
    <text class="empty-title">æš‚æ— å†å²è®°å½•</text>
    <text class="empty-desc">å¼€å§‹åˆ†æé±¼ç±»å›¾ç‰‡æˆ–è§†é¢‘ï¼Œè®°å½•å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</text>
  </view>

  <!-- è¯¦æƒ…æ¨¡æ€æ¡† -->
  <view wx:if="{{showDetailModal}}" class="detail-modal">
    <view class="modal-mask" bindtap="hideDetail"></view>
    <view class="modal-content">
      <view class="detail-header">
        <text class="detail-title">æ£€æµ‹è¯¦æƒ…</text>
        <view class="close-btn" bindtap="hideDetail">Ã—</view>
      </view>
      
      <scroll-view class="detail-body" scroll-y>
        <!-- åª’ä½“å±•ç¤º -->
        <view class="detail-media">
          <image wx:if="{{currentDetail.mediaType === 'image'}}" 
                 src="{{currentDetail.mediaUrl}}" 
                 mode="aspectFit"
                 class="detail-image"></image>
          <video wx:else 
                 src="{{currentDetail.mediaUrl}}" 
                 class="detail-video"
                 controls></video>
        </view>
        
        <!-- æ£€æµ‹ç»“æœ -->
        <view class="result-section">
          <view class="section-title">æ£€æµ‹ç»“æœ</view>
          <view class="result-item">
            <text class="label">å“ç§ï¼š</text>
            <text class="value">{{currentDetail.result.species.name || currentDetail.result.species || 'æœªçŸ¥'}}</text>
          </view>
          <view class="result-item">
            <text class="label">ç½®ä¿¡åº¦ï¼š</text>
            <text class="value">{{currentDetail.result.species.confidence || currentDetail.result.confidence || 0}}%</text>
          </view>
          <view wx:if="{{currentDetail.result.healthStatus}}" class="result-item">
            <text class="label">å¥åº·çŠ¶æ€ï¼š</text>
            <text class="value status-{{currentDetail.result.healthStatus}}">{{currentDetail.result.healthStatus === 'healthy' ? 'å¥åº·' : currentDetail.result.healthStatus === 'abnormal' ? 'å¼‚å¸¸' : 'ç–‘ä¼¼å¼‚å¸¸'}}</text>
          </view>
          <view class="result-item">
            <text class="label">æ£€æµ‹æ—¶é—´ï¼š</text>
            <text class="value">{{currentDetail.createTime}}</text>
          </view>
        </view>
        
        <!-- è¯¦ç»†æè¿° -->
        <view wx:if="{{currentDetail.result.description}}" class="result-section">
          <view class="section-title">è¯¦ç»†æè¿°</view>
          <text class="description">{{currentDetail.result.description}}</text>
        </view>
        
        <!-- å¥åº·é—®é¢˜ -->
        <view wx:if="{{currentDetail.result.issues && currentDetail.result.issues.length > 0}}" class="result-section">
          <view class="section-title">å‘ç°é—®é¢˜</view>
          <view class="issues-list">
            <view wx:for="{{currentDetail.result.issues}}" wx:key="*this" class="issue-item">
              {{item}}
            </view>
          </view>
        </view>
      </scroll-view>
      
      <view class="detail-footer">
        <button class="action-btn share-btn" bindtap="shareDetail">åˆ†äº«</button>
        <button class="action-btn delete-btn" bindtap="deleteHistory" data-id="{{currentDetail._id}}">åˆ é™¤</button>
      </view>
    </view>
  </view>

  <button class="back-btn" bindtap="goBack">è¿”å›æ£€æµ‹</button>
</view>