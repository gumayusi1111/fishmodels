<view class="container">
  <view class="header">
    <text class="title">å†å²è®°å½•</text>
  </view>

  <!-- æˆæƒæç¤º -->
  <view wx:if="{{needAuth}}" class="auth-prompt">
    <view class="auth-icon">ğŸ”</view>
    <text class="auth-title">éœ€è¦æˆæƒ</text>
    <text class="auth-desc">æŸ¥çœ‹å†å²è®°å½•éœ€è¦å…ˆæˆæƒè·å–ç”¨æˆ·ä¿¡æ¯</text>
    <button class="auth-btn" bindtap="getUserProfile">ç«‹å³æˆæƒ</button>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view wx:elif="{{loading}}" class="loading">
    <view class="loading-spinner"></view>
    <text>åŠ è½½ä¸­...</text>
  </view>

  <!-- å†å²è®°å½•åˆ—è¡¨ -->
  <view wx:elif="{{historyList.length > 0}}" class="history-list">
    <view class="list-header">
      <text class="record-count">å…± {{historyList.length}} æ¡è®°å½•</text>
    </view>
    
    <view wx:for="{{historyList}}" wx:key="_id" class="history-item-card" bindtap="showDetail" data-item="{{item}}">
      <!-- åª’ä½“é¢„è§ˆ -->
      <view class="media-preview">
        <image wx:if="{{item.mediaType === 'image'}}" 
               src="{{item.mediaUrl}}" 
               mode="aspectFill"
               class="preview-image"
               binderror="onImageError"></image>
        <image wx:elif="{{item.mediaType === 'video' && item.coverUrl}}" 
               src="{{item.coverUrl}}" 
               mode="aspectFill"
               class="preview-image"
               binderror="onImageError"></image>
        <view wx:else class="video-placeholder">
          <text class="video-icon">ğŸ¥</text>
          <text class="video-text">è§†é¢‘</text>
        </view>
        <view class="media-type-badge">{{item.mediaType === 'image' ? 'å›¾ç‰‡' : 'è§†é¢‘'}}</view>
      </view>
      
      <!-- å†…å®¹ä¿¡æ¯ -->
      <view class="content-info">
        <view class="species-info">
          <text class="species-name">{{item.result.species.name || item.result.species || 'æœªçŸ¥å“ç§'}}</text>
          <view class="confidence-badge confidence-{{item.result.species.confidence >= 80 ? 'high' : item.result.species.confidence >= 60 ? 'medium' : 'low'}}">
            {{item.result.species.confidence || item.result.confidence || 0}}%
          </view>
        </view>
        <view class="time-info">
          <text class="time-text">{{item.createTime}}</text>
        </view>
        <view wx:if="{{item.result.healthStatus}}" class="health-status status-{{item.result.healthStatus}}">
          {{item.result.healthStatus === 'healthy' ? 'å¥åº·' : item.result.healthStatus === 'abnormal' ? 'å¼‚å¸¸' : 'ç–‘ä¼¼å¼‚å¸¸'}}
        </view>
      </view>
      
      <!-- ç®­å¤´æŒ‡ç¤ºå™¨ -->
      <view class="arrow-indicator">
        <text class="arrow">â€º</text>
      </view>
    </view>
  </view>

  <!-- ç©ºçŠ¶æ€ -->
  <view wx:else class="empty-state">
    <view class="empty-icon">ğŸ“</view>
    <text class="empty-title">æš‚æ— å†å²è®°å½•</text>
    <text class="empty-desc">å¼€å§‹åˆ†æé±¼ç±»å›¾ç‰‡æˆ–è§†é¢‘ï¼Œè®°å½•å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</text>
  </view>

  <!-- è¯¦æƒ…æ¨¡æ€æ¡† -->
  <view wx:if="{{showDetailModal}}" class="detail-modal">
    <view class="modal-mask" bindtap="hideDetail"></view>
    <view class="modal-content">
      <view class="detail-header">
        <text class="detail-title">æ£€æµ‹è¯¦æƒ…</text>
        <view class="close-btn" bindtap="hideDetail">Ã—</view>
      </view>
      
      <scroll-view class="detail-body" scroll-y>
        <!-- åª’ä½“é¢„è§ˆ -->
        <view class="detail-media">
          <image wx:if="{{currentDetail.mediaType === 'image'}}" 
                 src="{{currentDetail.mediaUrl}}" 
                 class="detail-image"
                 mode="aspectFit"></image>
          <video wx:else 
                 src="{{currentDetail.mediaUrl}}" 
                 class="detail-video"
                 controls></video>
        </view>
        
        <!-- åˆ†æç»“æœå¡ç‰‡ -->
        <view class="result-cards">
          <!-- 1. ç‰©ç§ä¿¡æ¯å¡ç‰‡ -->
          <view class="result-card species-card" wx:if="{{currentDetail.result.species}}">
            <view class="card-header">
              <view class="card-icon species-icon">ğŸ </view>
              <view class="card-title-section">
                <text class="card-title">ç‰©ç§é‰´å®š</text>
                <view class="confidence-badge" wx:if="{{currentDetail.result.confidence || currentDetail.result.species.confidence}}">
                  <text class="confidence-text">{{currentDetail.result.species.confidence || currentDetail.result.confidence || 0}}%</text>
                </view>
              </view>
            </view>
            <view class="card-content">
              <view class="info-item primary">
                <text class="species-name">{{currentDetail.result.species.name || currentDetail.result.species || 'æœªçŸ¥'}}</text>
              </view>
              <view class="info-item" wx:if="{{currentDetail.result.description}}">
                <text class="info-label">æè¿°</text>
                <text class="info-value">{{currentDetail.result.description}}</text>
              </view>
              <view class="info-item" wx:if="{{currentDetail.result.habitat}}">
                <text class="info-label">æ –æ¯åœ°</text>
                <text class="info-value">{{currentDetail.result.habitat}}</text>
              </view>
              <view class="characteristics" wx:if="{{currentDetail.result.characteristics && currentDetail.result.characteristics.length > 0}}">
                <text class="info-label">ç‰¹å¾</text>
                <view class="tags-container">
                  <text wx:for="{{currentDetail.result.characteristics}}" wx:key="index" class="characteristic-tag">{{item}}</text>
                </view>
              </view>
            </view>
          </view>
      
          <!-- 2. å¥åº·çŠ¶æ€å¡ç‰‡ -->
          <view class="result-card health-card" wx:if="{{currentDetail.result.health || currentDetail.result.healthStatus}}">
            <view class="card-header">
              <view class="card-icon health-icon">ğŸ’š</view>
              <view class="card-title-section">
                <text class="card-title">å¥åº·è¯„ä¼°</text>
                <view class="health-score" wx:if="{{currentDetail.result.healthScore}}">
                  <text class="score-text">{{currentDetail.result.healthScore}}/100</text>
                </view>
              </view>
            </view>
            <view class="card-content">
              <view class="info-item primary">
                <view class="health-status {{(currentDetail.result.health === 'å¥åº·' || currentDetail.result.healthStatus === 'healthy') ? 'healthy' : 'unhealthy'}}">
                  <text class="status-text">{{currentDetail.result.health || (currentDetail.result.healthStatus === 'healthy' ? 'å¥åº·' : currentDetail.result.healthStatus === 'abnormal' ? 'å¼‚å¸¸' : 'ç–‘ä¼¼å¼‚å¸¸')}}</text>
                </view>
              </view>
              <view class="info-item" wx:if="{{currentDetail.result.disease && currentDetail.result.disease !== 'æ— '}}">
                <text class="info-label">ç–¾ç—…çŠ¶æ€</text>
                <text class="info-value">{{currentDetail.result.disease}}</text>
              </view>
              <view class="diseases-list" wx:if="{{currentDetail.result.diseases && currentDetail.result.diseases.length > 0}}">
                <text class="info-label">æ£€æµ‹åˆ°çš„ç–¾ç—…</text>
                <view class="disease-items">
                  <view wx:for="{{currentDetail.result.diseases}}" wx:key="index" class="disease-item">
                    <text class="disease-name">{{item}}</text>
                  </view>
                </view>
              </view>
              <view class="issues-list" wx:if="{{currentDetail.result.issues && currentDetail.result.issues.length > 0}}">
                <text class="info-label">å‘ç°é—®é¢˜</text>
                <view class="issue-items">
                  <view wx:for="{{currentDetail.result.issues}}" wx:key="index" class="issue-item">
                    <text class="issue-text">{{item}}</text>
                  </view>
                </view>
              </view>
            </view>
          </view>
      
          <!-- 3. æ²»ç–—å»ºè®®å¡ç‰‡ -->
          <view class="result-card treatment-card" wx:if="{{currentDetail.result.treatment}}">
            <view class="card-header">
              <view class="card-icon treatment-icon">ğŸ’¡</view>
              <view class="card-title-section">
                <text class="card-title">æ²»ç–—å»ºè®®</text>
              </view>
            </view>
            <view class="card-content">
              <view class="treatment-content">
                <text class="treatment-text">{{currentDetail.result.treatment}}</text>
              </view>
            </view>
          </view>
      
          <!-- 4. æ£€æµ‹ä¿¡æ¯å¡ç‰‡ -->
          <view class="result-card info-card">
            <view class="card-header">
              <view class="card-icon info-icon">â„¹ï¸</view>
              <view class="card-title-section">
                <text class="card-title">æ£€æµ‹ä¿¡æ¯</text>
              </view>
            </view>
            <view class="card-content">
              <view class="info-item">
                <text class="info-label">æ£€æµ‹æ—¶é—´</text>
                <text class="info-value">{{currentDetail.createTime}}</text>
              </view>
              <view class="info-item">
                <text class="info-label">åª’ä½“ç±»å‹</text>
                <text class="info-value">{{currentDetail.mediaType === 'image' ? 'å›¾ç‰‡' : 'è§†é¢‘'}}</text>
              </view>
            </view>
          </view>
        </view>
      </scroll-view>
      
      <view class="detail-footer">
        <button class="action-btn share-btn" bindtap="shareDetail">åˆ†äº«</button>
        <button class="action-btn delete-btn" bindtap="deleteHistory" data-id="{{currentDetail._id}}">åˆ é™¤</button>
      </view>
    </view>
  </view>

  <button class="back-btn" bindtap="goBack">è¿”å›æ£€æµ‹</button>
</view>